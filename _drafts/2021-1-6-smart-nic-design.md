# “高性能网络”设计__v0.1

由于底层技术原因（虚拟机热迁移等问题），我们没有办法将 vDPA+dpdk 网络与当前采用的 vhost 网络融合。在解决这些底层技术问题之前，我们目前可采取的方案是将这两种网络彻底分离开来，能做到这一点的最小粒度就是集群；“高性能网络”集群，以下简称新集群；

## 设计主旨

在进行实际的设计之前，我们统一几个设计主旨：

1. 新集群的使用与管理尽可能与普通集群统一；

## 控制平面

### 设计思路

#### 集群操作

创建新集群——指定集群类型(“高性能网络”集群)

添加物理机到新集群——判断物理机是否满足硬件设备要求，~~添加时对该物理机进行智能网卡相关的配置~~，若硬件不支持则添加失败；

从新集群中删除某物理机——删除时移除对物理机进行的智能网卡相关的配置

删除新集群——删除新集群下所有物理机的相关配置

#### 网络操作

为新集群挂载二层网络——结合选择的网卡类型，做不同的配置（物理机上可能同时存在智能网卡和普通的网卡）

为新集群卸载二层网络——根据网卡类型，做不同设置

之后所有网络设置都根据是否为”高性能网络集群”类型做额外处理。

#### API 使用流程

1. 使用 CreateCluster 指定**type**为“高性能网络”集群，创建集群；
2. 通过 AddKVMHost/AddXDragonHost 指定的 clusterUuid 判断集群类型，并检测物理机硬件支持；
3. 通过 CreateL2xxxlanNetwork 指定不同的网卡，创建不同类型的网络；
4. 在 AttachL2NetworkToCluster 时，根据指定的 clusterUuid 和 l2NetworkUuid 查询到的 physicalInterface 参数判断是否需要初始化为 vDPA+dpdk 网络模型；
5. 其余网络操作与普通集群相同；
6. DetachL2NetworkFromCluster 时，根据指定的 clusterUuid 和 l2NetworkUuid 查询到的 physicalInterface 参数判断如何删除网络；
7. 通过 DeleteLNetwork 删除 L2 网络；
8. 通过 DeleteHost 删除物理主机；
9. 通过 DeleteCluster 删除集群；

其他没有变化。

### 界面交互

在创建集群->高级选项中增加“高性能网络”集群选项。其他没有变化。

## 数据平面

待定。