---
layout: post
title:  "windows 设备接口"
subtitle: ""
date:   2020-2-19 9:13:45 +0800
tags:
  - Windows
  - driver
categories: [Windows]
comment: true
---

所有能够发出直接 I/O 请求的物理、逻辑或虚拟设备都需要为在用户模式下的客户端提供一些名字。通过使用这个名字，用户模式下的 app（或其他系统组件）才能够标识出需要使用 I/O 请求的设备。

在 WindowsNT4.0 和早期的 NT 操作系统中，驱动为自己的设备对象命名，并且在注册表中设置这些名称和用户可见的 Win32 逻辑名称的符号链接。

从 Windows2000 开始，驱动不再为设备对象命名。取而代之的是使用设备对象类（device interface classes）。一个设备对象类是一种向其他系统组件、驱动或用户模式应用输出设备和驱动功能的方式。一个驱动可以注册一个设备对象类，然后为每一个可能会使用到用户模式 I/O 请求的设备对象开启一个该类的实例。

每一个设备对象类都与一个 GUID 相关联，系统在设备描述头文件中为通用的设备对象类定义了 GUID。设备供应商也可以创建额外的设备对象类和对应的 GUID。

举例来说，三种不同类型的鼠标设备可能是相同的设备接口类的成员，即便可能第一个使用 USB 端口，第二个使用串口，第三个使用红外端口。每种驱动都将它的设备注册成 GUID_DEVINTERFACE_MOUSE 接口类的成员。这个 GUID 在头文件 Ntddmou.h 中定义。

通常来说，一个驱动只注册一种接口类。但是，除了为标准接口类定义的功能之外，设备的驱动程序还可以注册一个附加类。比如，一个能够挂载的磁盘驱动需要同时注册磁盘接口类（GUID_DEVINTERFACE_DISK）和设备接口类（MOUNTDEV_MOUNTED_DEVICE_GUID）。

当一个驱动注册了一个设备接口类的实例，I/O 管理器使用一个符号链接将设备和设备接口类 GUID 联系起来。这个链接名保存在注册表中并且在系统开启时存留。使用该接口的应用程序可以查询接口的实例并接收表示支持该接口的设备的符号链接名。然后，应用程序可以使用符号链接名作为 I/O 请求的目标。

# 使用设备接口

https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/using-device-interfaces